<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fafafa;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background-color: #45a049;
        }
        .memory-button {
            background-color: #2196F3;
        }
        .memory-button:hover {
            background-color: #0b7dda;
        }
        .danger-button {
            background-color: #f44336;
        }
        .danger-button:hover {
            background-color: #da190b;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background-color: #e7f3ff;
            border-left: 4px solid #2196F3;
            border-radius: 4px;
        }
        .memory-info {
            background-color: #f0f8ff;
            border: 1px solid #add8e6;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
        }
        .job-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .status-running {
            background-color: #fff3cd;
            border-color: #ffeaa7;
        }
        .status-completed {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        .status-failed {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #ddd;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.3s ease;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í…ŒìŠ¤íŠ¸</h1>
        
        <!-- í˜„ì¬ ë©”ëª¨ë¦¬ ìƒíƒœ -->
        <div class="test-section">
            <h3>ğŸ’¾ í˜„ì¬ ë©”ëª¨ë¦¬ ìƒíƒœ</h3>
            <button class="memory-button" onclick="checkMemoryStatus()">ë©”ëª¨ë¦¬ ìƒíƒœ í™•ì¸</button>
            <button class="danger-button" onclick="forceGC()">ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ ì‹¤í–‰</button>
            <div id="memoryStatus" class="memory-info" style="display: none;">
                ë©”ëª¨ë¦¬ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
            </div>
        </div>

        <!-- 50ë§Œê±´ ë°ì´í„° í…ŒìŠ¤íŠ¸ -->
        <div class="test-section">
            <h3>ğŸš€ 50ë§Œê±´ ë°ì´í„° ì²˜ë¦¬ í…ŒìŠ¤íŠ¸</h3>
            <p>ë‘ ê°€ì§€ ë°©ì‹ìœ¼ë¡œ 50ë§Œê±´ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ê³  ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì„ ë¹„êµí•©ë‹ˆë‹¤.</p>
            
            <div>
                <label>ë°ì´í„° í¬ê¸°: </label>
                <select id="dataSize">
                    <option value="10000">1ë§Œê±´</option>
                    <option value="50000">5ë§Œê±´</option>
                    <option value="100000">10ë§Œê±´</option>
                    <option value="500000" selected>50ë§Œê±´</option>
                    <option value="1000000">100ë§Œê±´</option>
                </select>
            </div>
            
            <button onclick="testLargeData()">ì¼ë°˜ ì²˜ë¦¬ (ì „ì²´ ë©”ëª¨ë¦¬ ë¡œë”©)</button>
            <button onclick="testStreamingData()">ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬ (ë©”ëª¨ë¦¬ íš¨ìœ¨ì )</button>
            <button onclick="testMemoryComparison()">í¬ê¸°ë³„ ë¹„êµ í…ŒìŠ¤íŠ¸</button>
            
            <div id="testResults"></div>
        </div>

        <!-- ì‹¤í–‰ ì¤‘ì¸ ì‘ì—… ëª¨ë‹ˆí„°ë§ -->
        <div class="test-section">
            <h3>âš™ï¸ ì‹¤í–‰ ì¤‘ì¸ ì‘ì—… ëª¨ë‹ˆí„°ë§</h3>
            <div id="jobMonitoring">
                ì‹¤í–‰ ì¤‘ì¸ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.
            </div>
        </div>

        <!-- ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ë¹„êµ í‘œ -->
        <div class="test-section">
            <h3>ğŸ“ˆ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ë¹„êµ</h3>
            <table id="memoryComparisonTable">
                <thead>
                    <tr>
                        <th>ë°ì´í„° í¬ê¸°</th>
                        <th>ì²˜ë¦¬ ë°©ì‹</th>
                        <th>ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰</th>
                        <th>ì²˜ë¦¬ ì‹œê°„</th>
                        <th>ìƒíƒœ</th>
                    </tr>
                </thead>
                <tbody id="comparisonTableBody">
                    <!-- ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let activeJobs = new Map();
        let monitoringInterval;

        // ë©”ëª¨ë¦¬ ìƒíƒœ í™•ì¸
        async function checkMemoryStatus() {
            try {
                const response = await fetch('/memory-test/memory-status');
                const memoryInfo = await response.json();
                
                const memoryDiv = document.getElementById('memoryStatus');
                memoryDiv.style.display = 'block';
                memoryDiv.innerHTML = `
                    <h4>í˜„ì¬ ë©”ëª¨ë¦¬ ìƒíƒœ</h4>
                    <p>ì‚¬ìš© ì¤‘: ${memoryInfo.usedMemoryMB.toLocaleString()}MB</p>
                    <p>ìµœëŒ€ ê°€ìš©: ${memoryInfo.maxMemoryMB.toLocaleString()}MB</p>
                    <p>ì‚¬ìš©ë¥ : ${memoryInfo.usagePercent.toFixed(2)}%</p>
                    <p>ì—¬ìœ  ë©”ëª¨ë¦¬: ${memoryInfo.freeMemoryMB.toLocaleString()}MB</p>
                `;
            } catch (error) {
                console.error('ë©”ëª¨ë¦¬ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
            }
        }

        // ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ ì‹¤í–‰
        async function forceGC() {
            try {
                const response = await fetch('/memory-test/gc', { method: 'POST' });
                const result = await response.text();
                alert(result);
                
                // ë©”ëª¨ë¦¬ ìƒíƒœ ë‹¤ì‹œ í™•ì¸
                checkMemoryStatus();
            } catch (error) {
                console.error('GC ì‹¤í–‰ ì‹¤íŒ¨:', error);
            }
        }

        // ì¼ë°˜ ëŒ€ìš©ëŸ‰ ë°ì´í„° í…ŒìŠ¤íŠ¸
        async function testLargeData() {
            const dataSize = document.getElementById('dataSize').value;
            
            try {
                const response = await fetch(`/memory-test/large-data?dataSize=${dataSize}`, {
                    method: 'POST'
                });
                const result = await response.text();
                
                // ì‘ì—… ID ì¶”ì¶œ
                const jobId = extractJobId(result);
                if (jobId) {
                    activeJobs.set(jobId, {
                        type: 'ì¼ë°˜ ì²˜ë¦¬',
                        dataSize: dataSize,
                        startTime: new Date()
                    });
                    startJobMonitoring();
                }
                
                addTestResult(result, 'success');
            } catch (error) {
                addTestResult('ì¼ë°˜ ì²˜ë¦¬ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        // ìŠ¤íŠ¸ë¦¬ë° ëŒ€ìš©ëŸ‰ ë°ì´í„° í…ŒìŠ¤íŠ¸
        async function testStreamingData() {
            const dataSize = document.getElementById('dataSize').value;
            
            try {
                const response = await fetch(`/memory-test/large-data-streaming?dataSize=${dataSize}`, {
                    method: 'POST'
                });
                const result = await response.text();
                
                // ì‘ì—… ID ì¶”ì¶œ
                const jobId = extractJobId(result);
                if (jobId) {
                    activeJobs.set(jobId, {
                        type: 'ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬',
                        dataSize: dataSize,
                        startTime: new Date()
                    });
                    startJobMonitoring();
                }
                
                addTestResult(result, 'success');
            } catch (error) {
                addTestResult('ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        // ë©”ëª¨ë¦¬ ë¹„êµ í…ŒìŠ¤íŠ¸
        async function testMemoryComparison() {
            try {
                const response = await fetch('/memory-test/memory-comparison', {
                    method: 'POST'
                });
                const result = await response.text();
                addTestResult(result, 'success');
                
                // ìë™ ëª¨ë‹ˆí„°ë§ ì‹œì‘
                startJobMonitoring();
            } catch (error) {
                addTestResult('ë¹„êµ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        // ì‘ì—… ID ì¶”ì¶œ
        function extractJobId(text) {
            const match = text.match(/ì‘ì—… ID: ([a-f0-9-]+)/);
            return match ? match[1] : null;
        }

        // í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì¶”ê°€
        function addTestResult(message, type) {
            const resultsDiv = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `
                <p><strong>${new Date().toLocaleTimeString()}</strong>: ${message}</p>
            `;
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        // ì‘ì—… ëª¨ë‹ˆí„°ë§ ì‹œì‘
        function startJobMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }
            
            monitoringInterval = setInterval(async () => {
                await updateJobStatuses();
            }, 2000); // 2ì´ˆë§ˆë‹¤ ìƒíƒœ ì²´í¬
        }

        // ì‘ì—… ìƒíƒœ ì—…ë°ì´íŠ¸
        async function updateJobStatuses() {
            const monitoringDiv = document.getElementById('jobMonitoring');
            
            if (activeJobs.size === 0) {
                monitoringDiv.innerHTML = 'ì‹¤í–‰ ì¤‘ì¸ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.';
                if (monitoringInterval) {
                    clearInterval(monitoringInterval);
                    monitoringInterval = null;
                }
                return;
            }
            
            let html = '<h4>ì‹¤í–‰ ì¤‘ì¸ ì‘ì—…ë“¤</h4>';
            
            for (const [jobId, jobMeta] of activeJobs) {
                try {
                    const response = await fetch(`/memory-test/job/${jobId}`);
                    const jobInfo = await response.json();
                    
                    const statusClass = `status-${jobInfo.status.toLowerCase()}`;
                    const elapsedTime = Math.floor((new Date() - jobMeta.startTime) / 1000);
                    
                    html += `
                        <div class="job-status ${statusClass}">
                            <strong>${jobMeta.type} (${Number(jobMeta.dataSize).toLocaleString()}ê±´)</strong>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${jobInfo.progress}%"></div>
                            </div>
                            <p>ìƒíƒœ: ${jobInfo.status} (${jobInfo.progress}%)</p>
                            <p>ë©”ì‹œì§€: ${jobInfo.message}</p>
                            <p>ê²½ê³¼ ì‹œê°„: ${elapsedTime}ì´ˆ</p>
                            <p>ì‘ì—… ID: ${jobId}</p>
                        </div>
                    `;
                    
                    // ì™„ë£Œëœ ì‘ì—… ì²˜ë¦¬
                    if (jobInfo.status === 'COMPLETED' || jobInfo.status === 'FAILED') {
                        // ë¹„êµ í…Œì´ë¸”ì— ì¶”ê°€
                        addToComparisonTable(jobMeta, jobInfo, elapsedTime);
                        
                        // í™œì„± ì‘ì—…ì—ì„œ ì œê±°
                        activeJobs.delete(jobId);
                        
                        // ë©”ëª¨ë¦¬ ìƒíƒœ ì—…ë°ì´íŠ¸
                        setTimeout(checkMemoryStatus, 1000);
                    }
                } catch (error) {
                    console.error(`ì‘ì—… ${jobId} ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:`, error);
                    activeJobs.delete(jobId);
                }
            }
            
            monitoringDiv.innerHTML = html;
        }

        // ë¹„êµ í…Œì´ë¸”ì— ê²°ê³¼ ì¶”ê°€
        function addToComparisonTable(jobMeta, jobInfo, elapsedTime) {
            const tableBody = document.getElementById('comparisonTableBody');
            const row = document.createElement('tr');
            
            // ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì •ë³´ ì¶”ì¶œ
            let memoryUsage = 'ì •ë³´ ì—†ìŒ';
            if (jobInfo.message && jobInfo.message.includes('ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰')) {
                const memoryMatch = jobInfo.message.match(/ìµœëŒ€ ì‚¬ìš©ëŸ‰: (\d+)MB/);
                if (memoryMatch) {
                    memoryUsage = memoryMatch[1] + 'MB';
                }
            }
            
            const statusColor = jobInfo.status === 'COMPLETED' ? '#4CAF50' : 
                               jobInfo.status === 'FAILED' ? '#f44336' : '#ff9800';
            
            row.innerHTML = `
                <td>${Number(jobMeta.dataSize).toLocaleString()}ê±´</td>
                <td>${jobMeta.type}</td>
                <td>${memoryUsage}</td>
                <td>${elapsedTime}ì´ˆ</td>
                <td style="color: ${statusColor}; font-weight: bold;">${jobInfo.status}</td>
            `;
            
            tableBody.appendChild(row);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ë©”ëª¨ë¦¬ ìƒíƒœ í™•ì¸
        window.onload = function() {
            checkMemoryStatus();
        };

        // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ëª¨ë‹ˆí„°ë§ ì •ë¦¬
        window.onbeforeunload = function() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }
        };
    </script>
</body>
</html>
